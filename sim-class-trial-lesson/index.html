<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <script src="./parser-01.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI äº’å‹•ä»‹é¢</title>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #f8fafc;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --round: 10px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      height: 100vh;
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden;
    }

    .container {
      display: grid;
      grid-template-columns: 350px 1fr 390px;
      height: 100vh;
      gap: 1px;
      background: var(--border);
    }

    /* å·¦å´é¢æ¿ */
    .left-panel {
      background: var(--panel);
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid var(--border);
    }

    .section {
      margin-bottom: 24px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .section-header {
      background: #ffffff;
      padding: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
    }

    .section-header:hover {
      background: #f1f5f9;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--accent);
      border-radius: 2px;
    }

    .collapse-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: transform 0.2s ease;
    }

    .section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .section-content {
      padding: 16px;
      background: #ffffff;
    }

    .section.collapsed .section-content {
      display: none;
    }

    .bot-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px;
      background: #f1f5f9;
      color: var(--muted);
    }

    .bot-status.active {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent);
    }

    .bot-status.scriptwriter {
      background: rgba(147, 51, 234, 0.2);
      color: #a855f7;
    }

    .bot-status.coach {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .input,
    .textarea,
    .select {
      width: 100%;
      background: #ffffff;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    .input:focus,
    .textarea:focus,
    .select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .textarea {
      resize: vertical;
      min-height: 80px;
      font-family: var(--mono);
    }

    .input[type="password"] {
      font-family: var(--mono);
    }

    .variables-section {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }

    .variable-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .variable-item:last-child {
      margin-bottom: 0;
    }

    .btn {
      background: linear-gradient(180deg, #16a34a, #15803d);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      width: 100%;
    }

    .btn:hover {
      filter: brightness(1.05);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.secondary {
      background: #f1f5f9;
      border-color: #e2e8f0;
      color: var(--text);
    }


    /* å³å´èŠå¤©å®¤ */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--panel);
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: #ffffff;
    }

    .chat-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .chat-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      max-width: 80%;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.assistant {
      align-self: flex-start;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: var(--accent);
      color: white;
    }

    .message.assistant .message-avatar {
      background: #3b82f6;
      color: white;
    }

    .message-content {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--text);
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: var(--accent);
      color: white;
      border-color: rgba(34, 197, 94, 0.3);
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
      padding: 12px 16px;
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 200px;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dot {
      width: 6px;
      height: 6px;
      background: var(--muted);
      border-radius: 50%;
      animation: thinking 1.4s infinite ease-in-out;
    }

    .thinking-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes thinking {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }

    .chat-input-container {
      padding: 20px;
      border-top: 1px solid var(--border);
      background: #ffffff;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      line-height: 1.5;
    }

    .chat-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .send-btn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 80px;
    }

    .send-btn:hover:not(:disabled) {
      filter: brightness(1.05);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      text-align: center;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 14px;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--err);
      padding: 12px 16px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
    }


    .premise-info {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-size: 13px;
      line-height: 1.5;
      color: var(--muted);
    }

    .premise-info.has-content {
      color: var(--text);
      border-color: #a855f7;
      background: rgba(147, 51, 234, 0.1);
    }

    .json-display {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.4;
      max-height: 200px;
      overflow-y: auto;
    }

    .json-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .json-title {
      font-weight: 600;
      color: var(--text);
      font-size: 13px;
    }

    .json-toggle {
      background: #e2e8f0;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s ease;
    }

    .json-toggle:hover {
      background: #cbd5e1;
    }

    .json-content {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .json-content.collapsed {
      max-height: 60px;
      overflow: hidden;
      position: relative;
    }

    .json-content.collapsed::after {
      content: '...';
      position: absolute;
      bottom: 0;
      right: 0;
      background: linear-gradient(transparent, #f8fafc);
      padding-left: 20px;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
    }

    .status-dot.connected {
      background: var(--accent);
    }

    /* å³å´å´é‚Šæ¬„ */
    .right-sidebar {
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: #ffffff;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .sidebar-header-content {
      flex: 1;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .empty-sidebar {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      text-align: center;
    }

    .empty-sidebar-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .empty-sidebar-text {
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .empty-sidebar-subtext {
      font-size: 12px;
    }

    .system-message {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .system-message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .system-message-icon {
      width: 24px;
      height: 24px;
      background: #a855f7;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .system-message-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .system-message-content {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* åˆ‡æ›ç« ç¯€æŒ‰éˆ• */
    .chapter-switch-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .chapter-switch-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
      color: var(--text);
    }

    /* é¸æ“‡ç« ç¯€ Dialog */
    .chapter-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .chapter-dialog-overlay.show {
      display: flex;
    }

    .chapter-dialog {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
    }

    .chapter-dialog-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chapter-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .chapter-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: all 0.2s ease;
    }

    .chapter-dialog-close:hover {
      background: #f1f5f9;
      color: var(--text);
    }

    .chapter-dialog-content {
      padding: 20px;
    }

    .chapter-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chapter-option {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #ffffff;
    }

    .chapter-option:hover {
      border-color: #3b82f6;
      background: #f8fafc;
    }

    .chapter-option.selected {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }

    .chapter-option-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .chapter-option-goal {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }

      .left-panel {
        max-height: 200px;
        overflow-y: auto;
      }

      .right-sidebar {
        max-height: 200px;
        overflow-y: auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- å·¦å´é¢æ¿ -->
    <div class="left-panel">

      <!-- ç·¨åŠ‡ Bot -->
      <div class="section collapsed" id="scriptwriterSection">
        <div class="section-header" onclick="toggleSection('scriptwriterSection')">
          <div class="section-title">
            <span id="scriptwriterTitle">ç·¨åŠ‡ Bot</span>
            <span class="bot-status scriptwriter" id="scriptwriterStatus">å¾…æ©Ÿä¸­</span>
          </div>
          <div class="collapse-icon">â–¼</div>
        </div>
        <div class="section-content">
          <div class="form-group">
            <label class="label" for="scriptwriterBotId">Bot ID</label>
            <input type="text" id="scriptwriterBotId" class="input" placeholder="è¼¸å…¥ç·¨åŠ‡ Bot ID">
          </div>
          <div class="form-group">
            <label class="label" for="scriptwriterVersion">Version</label>
            <input type="text" id="scriptwriterVersion" class="input" placeholder="è¼¸å…¥ç‰ˆæœ¬è™Ÿ">
          </div>
          <div class="premise-info" id="premiseInfo">
            å‰æƒ…æè¦è³‡è¨Šå°‡åœ¨æ­¤é¡¯ç¤º...
          </div>
        </div>
      </div>

      <!-- å­¸ç”Ÿ Bot -->
      <div class="section collapsed" id="studentSection">
        <div class="section-header" onclick="toggleSection('studentSection')">
          <div class="section-title">
            <span id="studentTitle">å­¸ç”Ÿ Bot</span>
            <span class="bot-status active" id="studentStatus">ä½¿ç”¨ä¸­</span>
          </div>
          <div class="collapse-icon">â–¼</div>
        </div>
        <div class="section-content">
          <div class="form-group">
            <label class="label" for="studentBotId">Bot ID</label>
            <input type="text" id="studentBotId" class="input" placeholder="è¼¸å…¥å­¸ç”Ÿ Bot ID">
          </div>
          <div class="form-group">
            <label class="label" for="studentVersion">Version</label>
            <input type="text" id="studentVersion" class="input" placeholder="è¼¸å…¥ç‰ˆæœ¬è™Ÿ">
          </div>
        </div>
      </div>

      <!-- æ•™ç·´ Bot -->
      <div class="section collapsed" id="coachSection">
        <div class="section-header" onclick="toggleSection('coachSection')">
          <div class="section-title">
            <span id="coachTitle">æ•™ç·´ Bot</span>
            <span class="bot-status coach" id="coachStatus">å¾…æ©Ÿä¸­</span>
          </div>
          <div class="collapse-icon">â–¼</div>
        </div>
        <div class="section-content">
          <div class="form-group">
            <label class="label" for="coachBotId">Bot ID</label>
            <input type="text" id="coachBotId" class="input" placeholder="è¼¸å…¥æ•™ç·´ Bot ID">
          </div>
          <div class="form-group">
            <label class="label" for="coachVersion">Version</label>
            <input type="text" id="coachVersion" class="input" placeholder="è¼¸å…¥ç‰ˆæœ¬è™Ÿ">
          </div>
        </div>
      </div>

      <!-- API è¨­å®š -->
      <div class="section collapsed" id="apiSection">
        <div class="section-header" onclick="toggleSection('apiSection')">
          <div class="section-title">
            <span>API è¨­å®š</span>
          </div>
          <div class="collapse-icon">â–¼</div>
        </div>
        <div class="section-content">
          <div class="form-group">
            <label class="label" for="apiKey">OpenAI API Key</label>
            <input type="password" id="apiKey" class="input" placeholder="sk-...">
          </div>
        </div>
      </div>

      <!-- æ§åˆ¶æŒ‰éˆ• -->
      <div class="section">
        <div class="section-content">
          <button id="createNewStudentBtn" class="btn"
            style="background: linear-gradient(180deg, #a855f7, #9333ea); margin-bottom: 8px;">
            å‰µå»ºæ–°çš„å­¸ç”Ÿè§’è‰²
          </button>
          <button id="summaryBtn" class="btn"
            style="background: linear-gradient(180deg, #3b82f6, #2563eb); margin-bottom: 8px;" disabled>
            <span id="summaryBtnText">æ•™ç·´ç¸½çµ</span>
          </button>
          <button id="clearChatBtn" class="btn secondary">æ¸…é™¤å°è©±</button>
        </div>
      </div>
    </div>

    <!-- ä¸­é–“èŠå¤©å®¤ -->
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">AI äº’å‹•ä»‹é¢</div>
        <div class="chat-subtitle">
          <span class="status-indicator">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">æœªé€£æ¥</span>
          </span>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ¤–</div>
          <div class="empty-state-text">é–‹å§‹èˆ‡ AI å°è©±</div>
          <div class="empty-state-subtext">åœ¨ä¸‹æ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥æ‚¨çš„è¨Šæ¯</div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea id="chatInput" class="chat-input" placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯... (æŒ‰ç™¼é€æŒ‰éˆ•é€å‡º)" rows="1"></textarea>
          <button id="sendBtn" class="send-btn">ç™¼é€</button>
        </div>
      </div>
    </div>

    <!-- å³å´å´é‚Šæ¬„ -->
    <div class="right-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-header-content">
          <div class="sidebar-title" id="sidebarTitle">æ¨¡æ“¬é«”é©—èª² part-1</div>
          <div class="sidebar-subtitle" id="sidebarSubtitle">ç›®æ¨™ï¼šå»ºç«‹å­¸ç”Ÿèˆ‡è€å¸«çš„åˆæ­¥äº’å‹•</div>
        </div>
        <button class="chapter-switch-btn" id="chapterSwitchBtn" title="åˆ‡æ›ç« ç¯€">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
          </svg>
        </button>
      </div>
      <div class="sidebar-content" id="sidebarContent">
        <div class="empty-sidebar">
          <div class="empty-sidebar-icon">ğŸ“</div>
          <div class="empty-sidebar-text">ç­‰å¾…ç·¨åŠ‡ç”¢ç”Ÿç³»çµ±è¨Šæ¯</div>
          <div class="empty-sidebar-subtext">é»æ“Šã€Œå‰µå»ºæ–°çš„å­¸ç”Ÿè§’è‰²ã€é–‹å§‹</div>
        </div>
      </div>
    </div>

    <!-- é¸æ“‡ç« ç¯€ Dialog -->
    <div class="chapter-dialog-overlay" id="chapterDialogOverlay">
      <div class="chapter-dialog">
        <div class="chapter-dialog-header">
          <h3 class="chapter-dialog-title">é¸æ“‡ç« ç¯€</h3>
          <button class="chapter-dialog-close" id="chapterDialogClose">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="chapter-dialog-content">
          <div class="chapter-options" id="chapterOptions">
            <!-- ç« ç¯€é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // å…¨åŸŸå‡½æ•¸ï¼šåˆ‡æ›å€å¡Šæ”¶åˆ
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }

    // å…¨åŸŸå‡½æ•¸ï¼šåˆ‡æ› JSON é¡¯ç¤ºæ”¶åˆ
    function toggleJsonDisplay() {
      const jsonContent = document.getElementById('jsonContent');
      const toggleBtn = document.querySelector('.json-toggle');

      if (jsonContent) {
        jsonContent.classList.toggle('collapsed');
        toggleBtn.textContent = jsonContent.classList.contains('collapsed') ? 'å±•é–‹' : 'æ”¶åˆ';
      }
    }

    // å…¨åŸŸç‰©ä»¶å„²å­˜ç·¨åŠ‡ Bot çš„å›æ‡‰
    window.scriptwriterResponse = null;

    class AIChatInterface {
      constructor() {
        this.currentBot = 'student'; // é è¨­ä½¿ç”¨å­¸ç”Ÿbot
        this.workflowStep = 'idle'; // idle, scriptwriter, student, coach
        this.chatHistory = [];

        // ç« ç¯€ç›®æ¨™è³‡æ–™
        // 1 é‡æ¸…éœ€æ±‚ï¼šè®“å­¸ç”Ÿæ›´æ¸…æ¥šè‡ªå·±æƒ³å­¸ä»€éº¼ã€ç‚ºä»€éº¼è¦å­¸
        // 2 ç¨‹åº¦åˆ†æï¼šå¹«å­¸ç”Ÿçœ‹æ¸…æ¥šã€Œç¾åœ¨çš„ç¨‹åº¦ã€èˆ‡ã€Œæƒ³è¦é”åˆ°çš„ç¨‹åº¦ã€
        // 3 ç¤ºç¯„æ•™å­¸ï¼šè®“å­¸ç”Ÿé«”é©—ã€Œå•é¡Œèƒ½è¢«è§£æ±ºã€
        // 4 å­¸ç¿’è¨ˆç•«ï¼šè®“å­¸ç”ŸçŸ¥é“å¯ä»¥æ€éº¼é–‹å§‹ã€å¯èƒ½å¤šä¹…æœƒæœ‰æ•ˆæœ
        // 5 è§£æ±ºç–‘æ…®ï¼šå¹«åŠ©å­¸ç”Ÿæ”¾å¿ƒåšä¸‹ä¸€æ­¥æ±ºå®š
        this.chapterGoals = {
          1: {
            title: 'é«”é©—èª² part-1 é‡æ¸…éœ€æ±‚',
            goal: 'è®“å­¸ç”Ÿæ›´æ¸…æ¥šè‡ªå·±æƒ³å­¸ä»€éº¼ã€ç‚ºä»€éº¼è¦å­¸'
          },
          2: {
            title: 'é«”é©—èª² part-2 ç¨‹åº¦åˆ†æ',
            goal: 'å¹«å­¸ç”Ÿçœ‹æ¸…æ¥šã€Œç¾åœ¨çš„ç¨‹åº¦ã€èˆ‡ã€Œæƒ³è¦é”åˆ°çš„ç¨‹åº¦ã€'
          },
          3: {
            title: 'é«”é©—èª² part-3 ç¤ºç¯„æ•™å­¸',
            goal: 'è®“å­¸ç”Ÿé«”é©—ã€Œå•é¡Œèƒ½è¢«è§£æ±ºã€'
          },
          4: {
            title: 'é«”é©—èª² part-4 å­¸ç¿’è¨ˆç•«',
            goal: 'è®“å­¸ç”ŸçŸ¥é“å¯ä»¥æ€éº¼é–‹å§‹ã€å¯èƒ½å¤šä¹…æœƒæœ‰æ•ˆæœ'
          },
          5: {
            title: 'é«”é©—èª² part-5 è§£æ±ºç–‘æ…®',
            goal: 'å¹«åŠ©å­¸ç”Ÿæ”¾å¿ƒåšä¸‹ä¸€æ­¥æ±ºå®š'
          }
        };

        this.initializeElements();
        this.initializeEventListeners();
        this.loadSettings();
        this.updateStatus('disconnected');

        // æª¢æŸ¥æ˜¯å¦æœ‰ scriptwriterResponseï¼Œæœ‰çš„è©±åŠ å…¥ç³»çµ±è¨Šæ¯ä¸¦æ›´æ–°ç‹€æ…‹
        this.checkAndLoadScriptwriterResponse();

        this.updateSummaryButton();
        this.updateSidebarInfo();
      }

      initializeElements() {
        this.elements = {

          // å·¦å´é¢æ¿ - ç·¨åŠ‡ Bot
          scriptwriterBotId: document.getElementById('scriptwriterBotId'),
          scriptwriterVersion: document.getElementById('scriptwriterVersion'),
          scriptwriterStatus: document.getElementById('scriptwriterStatus'),
          scriptwriterTitle: document.getElementById('scriptwriterTitle'),
          premiseInfo: document.getElementById('premiseInfo'),

          // å·¦å´é¢æ¿ - å­¸ç”Ÿ Bot
          studentBotId: document.getElementById('studentBotId'),
          studentVersion: document.getElementById('studentVersion'),
          studentStatus: document.getElementById('studentStatus'),
          studentTitle: document.getElementById('studentTitle'),

          // å·¦å´é¢æ¿ - æ•™ç·´ Bot
          coachBotId: document.getElementById('coachBotId'),
          coachVersion: document.getElementById('coachVersion'),
          coachStatus: document.getElementById('coachStatus'),
          coachTitle: document.getElementById('coachTitle'),

          // API è¨­å®š
          apiKey: document.getElementById('apiKey'),

          // æ§åˆ¶æŒ‰éˆ•
          createNewStudentBtn: document.getElementById('createNewStudentBtn'),
          clearChatBtn: document.getElementById('clearChatBtn'),
          summaryBtn: document.getElementById('summaryBtn'),
          summaryBtnText: document.getElementById('summaryBtnText'),

          // ä¸­é–“èŠå¤©å®¤
          chatMessages: document.getElementById('chatMessages'),
          chatInput: document.getElementById('chatInput'),
          sendBtn: document.getElementById('sendBtn'),
          statusDot: document.getElementById('statusDot'),
          statusText: document.getElementById('statusText'),

          // å³å´å´é‚Šæ¬„
          sidebarContent: document.getElementById('sidebarContent'),
          sidebarTitle: document.getElementById('sidebarTitle'),
          sidebarSubtitle: document.getElementById('sidebarSubtitle'),
          chapterSwitchBtn: document.getElementById('chapterSwitchBtn'),
          chapterDialogOverlay: document.getElementById('chapterDialogOverlay'),
          chapterDialogClose: document.getElementById('chapterDialogClose'),
          chapterOptions: document.getElementById('chapterOptions')
        };
      }

      initializeEventListeners() {
        // ç™¼é€æŒ‰éˆ•
        this.elements.sendBtn.addEventListener('click', () => this.sendMessage());


        // è‡ªå‹•èª¿æ•´è¼¸å…¥æ¡†é«˜åº¦
        this.elements.chatInput.addEventListener('input', () => {
          this.autoResizeTextarea();
        });


        // å‰µå»ºæ–°çš„å­¸ç”Ÿè§’è‰²
        this.elements.createNewStudentBtn.addEventListener('click', () => this.startScriptwriter());

        // ç¸½çµæŒ‰éˆ•
        this.elements.summaryBtn.addEventListener('click', () => this.generateSummary());

        // æ¸…é™¤å°è©±
        this.elements.clearChatBtn.addEventListener('click', () => this.clearChat());


        // è¨­å®šè®Šæ›´æ™‚å„²å­˜
        const settingsElements = [
          this.elements.scriptwriterBotId, this.elements.scriptwriterVersion,
          this.elements.studentBotId, this.elements.studentVersion,
          this.elements.coachBotId, this.elements.coachVersion,
          this.elements.apiKey
        ];

        settingsElements.forEach(el => {
          if (el) {
            const eventType = el.tagName === 'SELECT' ? 'change' : 'input';
            el.addEventListener(eventType, () => {
              this.saveSettings();
              this.updateBotTitles();
            });
          }
        });


        // åˆ‡æ›ç« ç¯€æŒ‰éˆ•
        this.elements.chapterSwitchBtn.addEventListener('click', () => this.showChapterDialog());

        // é—œé–‰ç« ç¯€é¸æ“‡ dialog
        this.elements.chapterDialogClose.addEventListener('click', () => this.hideChapterDialog());
        this.elements.chapterDialogOverlay.addEventListener('click', (e) => {
          if (e.target === this.elements.chapterDialogOverlay) {
            this.hideChapterDialog();
          }
        });
      }

      autoResizeTextarea() {
        const textarea = this.elements.chatInput;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      }

      loadSettings() {
        const settings = this.getStoredSettings();

        // ç·¨åŠ‡ Bot è¨­å®š
        this.elements.scriptwriterBotId.value = settings.scriptwriterBotId || '';
        this.elements.scriptwriterVersion.value = settings.scriptwriterVersion || '';

        // å­¸ç”Ÿ Bot è¨­å®š
        this.elements.studentBotId.value = settings.studentBotId || '';
        this.elements.studentVersion.value = settings.studentVersion || '';

        // æ•™ç·´ Bot è¨­å®š
        this.elements.coachBotId.value = settings.coachBotId || '';
        this.elements.coachVersion.value = settings.coachVersion || '';

        // API è¨­å®š
        this.elements.apiKey.value = settings.apiKey || '';


        // æ›´æ–°æ‰€æœ‰ Bot æ¨™é¡Œé¡¯ç¤ºç‰ˆæœ¬
        this.updateBotTitles();
      }


      checkAndLoadScriptwriterResponse() {
        const scriptResponse = getScript();
        if (scriptResponse && Object.keys(scriptResponse).length > 0) {
          // å¦‚æœæœ‰ scriptwriterResponseï¼Œè¨­å®šç‚º student éšæ®µä¸¦åŠ å…¥ç³»çµ±è¨Šæ¯
          this.workflowStep = 'student';
          this.currentBot = 'student';

          // æ›´æ–° bot ç‹€æ…‹
          this.elements.studentStatus.textContent = 'ä½¿ç”¨ä¸­';
          this.elements.studentStatus.className = 'bot-status active';
          this.elements.scriptwriterStatus.textContent = 'å·²å®Œæˆ';
          this.elements.scriptwriterStatus.className = 'bot-status scriptwriter';

          // å°‡ç³»çµ±è¨Šæ¯é¡¯ç¤ºåœ¨å³å´å´é‚Šæ¬„
          this.addSystemMessage(getTeacherHintText(scriptResponse, this.getChapterNumber()));
        }
      }

      updateBotTitles() {
        // æ›´æ–°ç·¨åŠ‡ Bot æ¨™é¡Œ
        const scriptwriterVersion = this.elements.scriptwriterVersion.value;
        const scriptwriterBaseName = 'ç·¨åŠ‡ Bot';
        this.elements.scriptwriterTitle.textContent = scriptwriterVersion
          ? `${scriptwriterBaseName} - v${scriptwriterVersion}`
          : scriptwriterBaseName;

        // æ›´æ–°å­¸ç”Ÿ Bot æ¨™é¡Œ
        const studentVersion = this.elements.studentVersion.value;
        const studentBaseName = 'å­¸ç”Ÿ Bot';
        this.elements.studentTitle.textContent = studentVersion
          ? `${studentBaseName} - v${studentVersion}`
          : studentBaseName;

        // æ›´æ–°æ•™ç·´ Bot æ¨™é¡Œ
        const coachVersion = this.elements.coachVersion.value;
        const coachBaseName = 'æ•™ç·´ Bot';
        this.elements.coachTitle.textContent = coachVersion
          ? `${coachBaseName} - v${coachVersion}`
          : coachBaseName;
      }

      selectChapterNumber(chapterNumber) {
        // å„²å­˜é¸ä¸­çš„æ•¸å€¼åˆ° localStorage
        localStorage.setItem('selectedNumber', chapterNumber.toString());

        // æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
        this.updateSidebarInfo();

        // æ›´æ–°ç« ç¯€å¾Œé‡æ–°è¼‰å…¥ç³»çµ±æç¤º
        this.reloadSystemPrompt();
      }

      getChapterNumber() {
        return parseInt(localStorage.getItem('selectedNumber') || '1');
      }

      updateSidebarInfo() {
        const chapterNumber = this.getChapterNumber();
        const chapterInfo = this.chapterGoals[chapterNumber];

        if (chapterInfo) {
          this.elements.sidebarTitle.textContent = chapterInfo.title;
          this.elements.sidebarSubtitle.textContent = `ç›®æ¨™ï¼š${chapterInfo.goal}`;
        }
      }

      showChapterDialog() {
        // ç”Ÿæˆç« ç¯€é¸é …
        this.generateChapterOptions();

        // é¡¯ç¤º dialog
        this.elements.chapterDialogOverlay.classList.add('show');
      }

      hideChapterDialog() {
        this.elements.chapterDialogOverlay.classList.remove('show');
      }

      generateChapterOptions() {
        const currentChapter = this.getChapterNumber();

        // æ¸…ç©ºç¾æœ‰é¸é …
        this.elements.chapterOptions.innerHTML = '';

        // ç”Ÿæˆç« ç¯€é¸é …
        Object.entries(this.chapterGoals).forEach(([chapterNumber, chapterInfo]) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = `chapter-option ${parseInt(chapterNumber) === currentChapter ? 'selected' : ''}`;
          optionDiv.dataset.chapter = chapterNumber;

          optionDiv.innerHTML = `
            <div class="chapter-option-title">${chapterInfo.title}</div>
            <div class="chapter-option-goal">ç›®æ¨™ï¼š${chapterInfo.goal}</div>
          `;

          // é»æ“Šäº‹ä»¶
          optionDiv.addEventListener('click', () => {
            this.selectChapterFromDialog(parseInt(chapterNumber));
          });

          this.elements.chapterOptions.appendChild(optionDiv);
        });
      }

      selectChapterFromDialog(chapterNumber) {
        // ç›´æ¥èª¿ç”¨ selectChapterNumber
        this.selectChapterNumber(chapterNumber);

        // é—œé–‰ dialog
        this.hideChapterDialog();
      }

      reloadSystemPrompt() {
        // æª¢æŸ¥æ˜¯å¦æœ‰ scriptwriterResponse
        const scriptResponse = getScript();
        if (scriptResponse && Object.keys(scriptResponse).length > 0) {
          // æ¸…é™¤ç¾æœ‰èŠå¤©è¨˜éŒ„
          this.clearChatMessages();

          // é‡æ–°è¨­å®šå·¥ä½œæµç¨‹ç‹€æ…‹
          this.workflowStep = 'student';
          this.currentBot = 'student';

          // æ›´æ–° bot ç‹€æ…‹
          this.elements.studentStatus.textContent = 'ä½¿ç”¨ä¸­';
          this.elements.studentStatus.className = 'bot-status active';
          this.elements.scriptwriterStatus.textContent = 'å·²å®Œæˆ';
          this.elements.scriptwriterStatus.className = 'bot-status scriptwriter';

          // å°‡ç³»çµ±æç¤ºè¨Šæ¯é¡¯ç¤ºåœ¨å³å´å´é‚Šæ¬„
          this.addSystemMessage(getTeacherHintText(scriptResponse, this.getChapterNumber()));

          // æ›´æ–°ç¸½çµæŒ‰éˆ•ç‹€æ…‹
          this.updateSummaryButton();
        }
      }

      clearChatMessages() {
        // æ¸…é™¤èŠå¤©è¨˜éŒ„
        this.chatHistory = [];

        // æ¸…é™¤èŠå¤©é¡¯ç¤ºå€åŸŸ
        this.elements.chatMessages.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¤–</div>
            <div class="empty-state-text">é–‹å§‹èˆ‡ AI å°è©±</div>
            <div class="empty-state-subtext">åœ¨ä¸‹æ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥æ‚¨çš„è¨Šæ¯</div>
          </div>
        `;

        // é‡ç½®ç‹€æ…‹
        this.updateStatus('disconnected');
      }



      saveSettings() {
        const settings = {
          // ç·¨åŠ‡ Bot è¨­å®š
          scriptwriterBotId: this.elements.scriptwriterBotId.value,
          scriptwriterVersion: this.elements.scriptwriterVersion.value,

          // å­¸ç”Ÿ Bot è¨­å®š
          studentBotId: this.elements.studentBotId.value,
          studentVersion: this.elements.studentVersion.value,

          // æ•™ç·´ Bot è¨­å®š
          coachBotId: this.elements.coachBotId.value,
          coachVersion: this.elements.coachVersion.value,

          // API è¨­å®š
          apiKey: this.elements.apiKey.value
        };
        localStorage.setItem('aiChatSettings', JSON.stringify(settings));
      }

      getStoredSettings() {
        try {
          return JSON.parse(localStorage.getItem('aiChatSettings') || '{}');
        } catch {
          return {};
        }
      }

      getVariables(botType = 'student') {
        const selectedNumber = this.getChapterNumber();
        const variables = getAIParams(getScript(), selectedNumber)

        switch (botType) {
          case 'student':
            delete variables.check_list
            break;
          case 'coach':
            delete variables.dialog
            break;
          default:
            return {}
        }

        return variables;
      }

      // å•Ÿå‹•ç·¨åŠ‡ Bot
      async startScriptwriter() {
        if (!this.elements.scriptwriterBotId.value.trim()) {
          this.showError('è«‹å…ˆè¨­å®šç·¨åŠ‡ Bot ID');
          return;
        }

        if (!this.elements.apiKey.value.trim()) {
          this.showError('è«‹å…ˆè¨­å®š OpenAI API Key');
          return;
        }

        this.workflowStep = 'scriptwriter';
        this.elements.createNewStudentBtn.disabled = true;
        this.elements.createNewStudentBtn.textContent = 'ç·¨åŠ‡ Bot é‹è¡Œä¸­...';
        this.elements.scriptwriterStatus.textContent = 'é‹è¡Œä¸­';
        this.elements.scriptwriterStatus.className = 'bot-status scriptwriter';

        try {
          const response = await this.callOpenAI('scriptwriter', 'Please provide json response with premise information');

          // å„²å­˜åˆ°å…¨åŸŸç‰©ä»¶
          window.scriptwriterResponse = response;

          // å„²å­˜åˆ° localStorage
          localStorage.setItem('scriptwriterResponse', response);

          // è™•ç† JSON å›æ‡‰é¡¯ç¤º
          this.displayJsonResponse(response);

          // åˆ‡æ›åˆ°å­¸ç”Ÿ Bot
          this.workflowStep = 'student';
          this.currentBot = 'student';
          this.elements.studentStatus.textContent = 'ä½¿ç”¨ä¸­';
          this.elements.studentStatus.className = 'bot-status active';
          this.elements.scriptwriterStatus.textContent = 'å·²å®Œæˆ';
          this.elements.scriptwriterStatus.className = 'bot-status scriptwriter';

          this.addSystemMessage(getTeacherHintText(getScript(), this.getChapterNumber()));
          this.updateSummaryButton();

        } catch (error) {
          this.showError(`ç·¨åŠ‡ Bot éŒ¯èª¤: ${error.message}`);
          this.elements.scriptwriterStatus.textContent = 'éŒ¯èª¤';
          this.elements.scriptwriterStatus.className = 'bot-status';
        } finally {
          this.elements.createNewStudentBtn.disabled = false;
          this.elements.createNewStudentBtn.textContent = 'å‰µå»ºæ–°çš„å­¸ç”Ÿè§’è‰²';
        }
      }

      // ç”Ÿæˆç¸½çµ
      async generateSummary() {
        if (!this.elements.coachBotId.value.trim()) {
          this.showError('è«‹å…ˆè¨­å®šæ•™ç·´ Bot ID');
          return;
        }

        if (this.chatHistory.length === 0) {
          this.showError('æ²’æœ‰å°è©±è¨˜éŒ„å¯ä»¥ç¸½çµ');
          return;
        }

        this.elements.summaryBtn.disabled = true;
        this.elements.summaryBtnText.textContent = 'ç¸½çµä¸­...';

        try {
          const chatHistoryText = this.chatHistory.map(msg =>
            `${msg.role === 'user' ? 'ç”¨æˆ¶' : 'AI'}: ${msg.content}`
          ).join('\n\n');

          const summary = await this.callOpenAI('coach');

          this.addMessage(`ğŸ“‹ **æ•™ç·´ç¸½çµ**\n\n${summary}`, 'coach');
          this.elements.coachStatus.textContent = 'å·²å®Œæˆ';
          this.elements.coachStatus.className = 'bot-status coach';

        } catch (error) {
          this.showError(`æ•™ç·´ Bot éŒ¯èª¤: ${error.message}`);
        } finally {
          this.elements.summaryBtn.disabled = false;
          this.elements.summaryBtnText.textContent = 'æ•™ç·´ç¸½çµ';
        }
      }

      // æ›´æ–°ç¸½çµæŒ‰éˆ•ç‹€æ…‹
      updateSummaryButton() {
        const hasChatHistory = this.chatHistory.length > 0;
        const canSummarize = hasChatHistory;

        this.elements.summaryBtn.disabled = !canSummarize;

        if (canSummarize) {
          this.elements.summaryBtnText.textContent = 'æ•™ç·´ç¸½çµ';
        } else {
          this.elements.summaryBtnText.textContent = 'æ•™ç·´ç¸½çµ';
        }
      }

      updateStatus(status) {
        const statusMap = {
          'connected': { text: 'å·²é€£æ¥', class: 'connected' },
          'disconnected': { text: 'æœªé€£æ¥', class: '' },
          'thinking': { text: 'æ€è€ƒä¸­...', class: '' }
        };

        const statusInfo = statusMap[status] || statusMap['disconnected'];
        this.elements.statusText.textContent = statusInfo.text;
        this.elements.statusDot.className = `status-dot ${statusInfo.class}`;
      }

      addMessage(content, role = 'user') {
        // ç§»é™¤ç©ºç‹€æ…‹
        const emptyState = this.elements.chatMessages.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = role === 'user' ? 'U' : 'AI';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = content.replace(/\n/g, '<br>');

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        this.elements.chatMessages.appendChild(messageDiv);

        // æ»¾å‹•åˆ°åº•éƒ¨
        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
      }

      addSystemMessage(content) {
        // æ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„ç³»çµ±è¨Šæ¯
        const existingMessages = this.elements.sidebarContent.querySelectorAll('.system-message');
        existingMessages.forEach(message => message.remove());

        // ç§»é™¤ç©ºç‹€æ…‹
        const emptySidebar = this.elements.sidebarContent.querySelector('.empty-sidebar');
        if (emptySidebar) {
          emptySidebar.remove();
        }

        const systemMessageDiv = document.createElement('div');
        systemMessageDiv.className = 'system-message';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'system-message-header';

        const iconDiv = document.createElement('div');
        iconDiv.className = 'system-message-icon';
        iconDiv.textContent = 'S';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'system-message-title';
        titleDiv.textContent = 'ç³»çµ±æç¤º';

        headerDiv.appendChild(iconDiv);
        headerDiv.appendChild(titleDiv);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'system-message-content';
        contentDiv.textContent = content;

        systemMessageDiv.appendChild(headerDiv);
        systemMessageDiv.appendChild(contentDiv);
        this.elements.sidebarContent.appendChild(systemMessageDiv);

        // æ»¾å‹•åˆ°åº•éƒ¨
        this.elements.sidebarContent.scrollTop = this.elements.sidebarContent.scrollHeight;
      }

      addThinkingIndicator() {
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'message assistant';
        thinkingDiv.id = 'thinkingIndicator';

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = 'AI';

        const thinkingContent = document.createElement('div');
        thinkingContent.className = 'thinking-indicator';
        thinkingContent.innerHTML = `
                    <span>æ€è€ƒä¸­</span>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                `;

        thinkingDiv.appendChild(avatar);
        thinkingDiv.appendChild(thinkingContent);
        this.elements.chatMessages.appendChild(thinkingDiv);

        // æ»¾å‹•åˆ°åº•éƒ¨
        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
      }

      removeThinkingIndicator() {
        const thinkingIndicator = document.getElementById('thinkingIndicator');
        if (thinkingIndicator) {
          thinkingIndicator.remove();
        }
      }

      async sendMessage() {
        const message = this.elements.chatInput.value.trim();
        if (!message) return;

        // æª¢æŸ¥å¿…è¦è¨­å®š
        if (!this.elements.apiKey.value.trim()) {
          this.showError('è«‹å…ˆè¨­å®š OpenAI API Key');
          return;
        }

        // æª¢æŸ¥ç•¶å‰ bot çš„è¨­å®š
        const currentBotId = this.getCurrentBotId();
        if (!currentBotId) {
          this.showError(`è«‹å…ˆè¨­å®š ${this.getCurrentBotName()} Bot ID`);
          return;
        }

        // æ·»åŠ ç”¨æˆ¶è¨Šæ¯åˆ°èŠå¤©è¨˜éŒ„
        this.chatHistory.push({ role: 'user', content: message });
        this.addMessage(message, 'user');
        this.elements.chatInput.value = '';
        this.autoResizeTextarea();

        // é¡¯ç¤ºæ€è€ƒä¸­ç‹€æ…‹
        this.addThinkingIndicator();
        this.updateStatus('thinking');
        this.elements.sendBtn.disabled = true;

        try {
          const response = await this.callOpenAI(this.currentBot);
          this.removeThinkingIndicator();

          // æ·»åŠ  AI å›æ‡‰åˆ°èŠå¤©è¨˜éŒ„
          this.chatHistory.push({ role: 'assistant', content: response });
          this.addMessage(response, 'assistant');
          this.updateStatus('connected');

          // æ›´æ–°ç¸½çµæŒ‰éˆ•ç‹€æ…‹
          this.updateSummaryButton();

        } catch (error) {
          this.removeThinkingIndicator();
          this.addMessage(`éŒ¯èª¤: ${error.message}`, 'assistant');
          this.updateStatus('disconnected');
        } finally {
          this.elements.sendBtn.disabled = false;
        }
      }

      getCurrentBotId() {
        switch (this.currentBot) {
          case 'scriptwriter':
            return this.elements.scriptwriterBotId.value.trim();
          case 'student':
            return this.elements.studentBotId.value.trim();
          case 'coach':
            return this.elements.coachBotId.value.trim();
          default:
            return null;
        }
      }

      getCurrentBotName() {
        switch (this.currentBot) {
          case 'scriptwriter':
            return 'ç·¨åŠ‡';
          case 'student':
            return 'å­¸ç”Ÿ';
          case 'coach':
            return 'æ•™ç·´';
          default:
            return 'æœªçŸ¥';
        }
      }

      getChatMessages() {
        const messages = this.chatHistory
          .filter(msg => msg.role === 'user' || msg.role === 'assistant')
          .map(msg => ({
            role: msg.role,
            content: [
              {
                type: msg.role === 'user' ? 'input_text' : 'output_text',
                text: msg.content
              }
            ]
          }));

        console.log('messages: ', messages);

        return messages;
      }

      async callOpenAI(botType = 'student', input = this.getChatMessages()) {
        const variables = this.getVariables(botType);

        // æ ¹æ“š bot é¡å‹ç²å–å°æ‡‰çš„è¨­å®š
        let botId, version;
        switch (botType) {
          case 'scriptwriter':
            botId = this.elements.scriptwriterBotId.value.trim();
            version = this.elements.scriptwriterVersion.value.trim();
            break;
          case 'student':
            botId = this.elements.studentBotId.value.trim();
            version = this.elements.studentVersion.value.trim();
            break;
          case 'coach':
            botId = this.elements.coachBotId.value.trim();
            version = this.elements.coachVersion.value.trim();
            break;
          default:
            throw new Error('æœªçŸ¥çš„ bot é¡å‹');
        }

        if (!input) {
          input = [
            {
              role: 'user',
              content: [
                { type: 'input_text', text: '' }
              ]
            }
          ]
        } else if (typeof input === 'string') {
          input = [
            {
              role: 'user',
              content: [
                { type: 'input_text', text: input }
              ]
            }
          ]
        }

        // ä½¿ç”¨ OpenAI responses API ä¾†å‘¼å«ç‰¹å®šçš„ Bot
        const url = `https://api.openai.com/v1/responses`;
        const body = {
          prompt: {
            id: botId,
            version: version,
            variables: variables
          },
          input
        };

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.elements.apiKey.value.trim()}`
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`API éŒ¯èª¤: ${response.status} - ${errorData.error?.message || response.statusText}`);
        }

        const data = await response.json();
        // responses API çš„å›æ‡‰æ ¼å¼èˆ‡ chat completions ä¸åŒ
        return (data.output || []).find(item => item.status === 'completed')?.content[0]?.text;
      }

      displayJsonResponse(jsonResponse) {
        try {
          // å˜—è©¦è§£æ JSON
          const jsonObj = typeof jsonResponse === 'string' ? JSON.parse(jsonResponse) : jsonResponse;
          const formattedJson = JSON.stringify(jsonObj, null, 2);

          // æ›´æ–°å‰æƒ…æè¦é¡¯ç¤º
          this.elements.premiseInfo.innerHTML = `
            <div class="json-display">
              <div class="json-header">
                <div class="json-title">ç·¨åŠ‡ Bot å›æ‡‰ (JSON)</div>
                <button class="json-toggle" onclick="toggleJsonDisplay()">æ”¶åˆ</button>
              </div>
              <div class="json-content" id="jsonContent">${formattedJson}</div>
            </div>
          `;
          this.elements.premiseInfo.className = 'premise-info has-content';

        } catch (error) {
          // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œé¡¯ç¤ºåŸå§‹å›æ‡‰
          this.elements.premiseInfo.textContent = jsonResponse;
          this.elements.premiseInfo.className = 'premise-info has-content';
        }
      }


      showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;

        this.elements.chatMessages.appendChild(errorDiv);

        // 3ç§’å¾Œè‡ªå‹•ç§»é™¤éŒ¯èª¤è¨Šæ¯
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.remove();
          }
        }, 3000);
      }

      clearChat() {
        this.elements.chatMessages.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¤–</div>
            <div class="empty-state-text">é–‹å§‹èˆ‡ AI å°è©±</div>
            <div class="empty-state-subtext">åœ¨ä¸‹æ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥æ‚¨çš„è¨Šæ¯</div>
          </div>
        `;
        this.updateStatus('disconnected');

        // æ¸…é™¤å³å´å´é‚Šæ¬„
        this.elements.sidebarContent.innerHTML = `
          <div class="empty-sidebar">
            <div class="empty-sidebar-icon">ğŸ“</div>
            <div class="empty-sidebar-text">ç­‰å¾…ç·¨åŠ‡ç”¢ç”Ÿç³»çµ±è¨Šæ¯</div>
            <div class="empty-sidebar-subtext">é»æ“Šã€Œå‰µå»ºæ–°çš„å­¸ç”Ÿè§’è‰²ã€é–‹å§‹</div>
          </div>
        `;

        // é‡ç½®å·¥ä½œæµç¨‹
        this.workflowStep = 'idle';
        this.currentBot = 'student';
        this.chatHistory = [];

        // é‡ç½® bot ç‹€æ…‹
        this.elements.scriptwriterStatus.textContent = 'å¾…æ©Ÿä¸­';
        this.elements.scriptwriterStatus.className = 'bot-status scriptwriter';
        this.elements.studentStatus.textContent = 'ä½¿ç”¨ä¸­';
        this.elements.studentStatus.className = 'bot-status active';
        this.elements.coachStatus.textContent = 'å¾…æ©Ÿä¸­';
        this.elements.coachStatus.className = 'bot-status coach';

        // é‡ç½®å‰æƒ…æè¦
        this.elements.premiseInfo.textContent = 'ç·¨åŠ‡å›æ‡‰';
        this.elements.premiseInfo.className = 'premise-info';

        // æ¸…é™¤ç·¨åŠ‡å›æ‡‰çš„ localStorage
        localStorage.removeItem('scriptwriterResponse');
        window.scriptwriterResponse = null;

        // é‡ç½®æŒ‰éˆ•
        this.elements.createNewStudentBtn.disabled = false;
        this.elements.createNewStudentBtn.textContent = 'å‰µå»ºæ–°çš„å­¸ç”Ÿè§’è‰²';
        this.updateSummaryButton();
      }
    }

    // é é¢è¼‰å…¥æ™‚ç«‹å³å¾ localStorage è¼‰å…¥ scriptwriterResponse
    function getScript() {
      const storedResponse = localStorage.getItem('scriptwriterResponse');
      if (storedResponse) {
        try {
          let response = JSON.parse(storedResponse);
          // æª¢æŸ¥å¦‚æœé‚„æ˜¯å­—ä¸²å°±å†æ¬¡ parse
          if (typeof response === 'string') {
            response = JSON.parse(response);
          }
          return response;
        } catch (error) {
          console.error('è¼‰å…¥ scriptwriterResponse æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
          return {}
        }
      }
    }

    // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
    document.addEventListener('DOMContentLoaded', () => {
      new AIChatInterface();
    });
  </script>
</body>

</html>